# Лабораторная работа №2: Трекинг объекта на видео на основе ключевых точек

**Цель работы:** Реализация и тестирование алгоритма трекинга объекта на видео с использованием детектора ключевых точек Shi-Tomasi и оптического потока Лукаса-Канаде.

<img width="1538" height="933" alt="image" src="https://github.com/user-attachments/assets/df7ae650-b961-45fd-87a8-beb80025ec94" />


## 1. Теоретическая база

### 1.1 Метод Shi-Tomasi для обнаружения ключевых точек

Алгоритм Shi-Tomasi ("Good Features to Track") является улучшением детектора углов Харриса. Он основан на анализе матрицы вторых моментов (автокорреляционной матрицы). В отличие от детектора Харриса, метод Shi-Tomasi использует минимальное собственное значение матрицы M. Точка считается угловой, если минимальное из собственных значений превышает заданный порог. Этот критерий позволяет получать более устойчивые к шуму и лучше распределенные точки.

### 1.2 Оптический поток Лукаса-Канаде

Оптический поток описывает векторное поле смещений пикселей между последовательными кадрами видео. Метод Лукаса-Канаде основан на предположениях о постоянстве яркости, малом перемещении и пространственной согласованности. Для обработки больших перемещений используется пирамидальный подход.

## 2. Описание разработанной системы

### 2.1 Архитектура алгоритма

Разработанный алгоритм реализует следующий рабочий процесс:

1. **Инициализация**:
   - Загрузка входного видеофайла
   - Извлечение первого кадра как эталонного изображения
   - Поиск ключевых точек методом Shi-Tomasi на первом кадре

2. **Последовательная обработка кадров**:
   - Для каждого нового кадра вычисляется оптический поток между предыдущим и текущим кадром
   - Фильтрация успешно отслеженных точек по статусу трекинга
   - Построение ограничивающего прямоугольника по текущему набору точек
   - Визуализация точек и прямоугольника на кадре

3. **Управление жизненным циклом точек**:
   - Автоматическая переинициализация при падении количества точек ниже порога
   - Непрерывный мониторинг качества трекинга

### 2.2 Ключевые параметры реализации

feature_params = dict(
    maxCorners=500,
    qualityLevel=0.05,
    minDistance=7,
    blockSize=7
)

lk_params = dict(
    winSize=(15, 15),
    maxLevel=2,
    criteria=(cv2.TERM_CRITERIA_EPS | cv2.TERM_CRITERIA_COUNT, 10, 0.03)
)

- reinit_min_points=30 - порог для переинициализации
- min_points_for_box=10 - минимальное количество точек для построения прямоугольника

### 2.3 Особенности реализации

1. Адаптивная переинициализация: При снижении количества отслеживаемых точек ниже 30, алгоритм автоматически ищет новые точки на текущем кадре.

2. Статистический мониторинг: Сбор данных о количестве ключевых точек в каждом кадре для последующего анализа.

3. Вращающийся прямоугольник: Использование cv2.minAreaRect() для построения минимального по площади прямоугольника, охватывающего все точки, что позволяет точно отслеживать повороты объекта.

4. Интеграция с Google Colab: Код адаптирован для работы в облачной среде с возможностью загрузки видео и скачивания результатов.

## 3. Результаты работы и тестирования системы

### 3.1 Тестирование на различных видео

Алгоритм был протестирован на трех типах видео:

1. Видео с четким текстурированным объектом - стабильный трекинг с высокой точностью
2. Видео с размытием и шумом - умеренная деградация качества трекинга
3. Пользовательское видео с объектом "Мона Лиза" - хорошая работа алгоритма при плавных движениях

### 3.2 График зависимости числа ключевых точек от времени

Для анализа работы алгоритма была построена зависимость количества отслеживаемых ключевых точек от времени:

<img width="888" height="392" alt="image" src="https://github.com/user-attachments/assets/c55ee91f-ccdc-47c7-a6fb-0ae35f2726d2" />


На графике видно:
- Начальное количество точек: ~300
- Стабильное удержание точек в диапазоне 50-200 на протяжении всего видео
- Периодические переинициализации (резкие увеличения количества точек)
- Общая тенденция к снижению количества точек со временем, что соответствует теории оптического потока

### 3.3 Количественные результаты

- Общее количество кадров обработано: ~540 (при 30 FPS ≈ 18 секунд видео)
- Кадров с успешным построением рамки: ~450 (83% успешных кадров)
- Среднее количество точек на кадр: ~120
- Количество переинициализаций: 4-5 за все видео

## 4. Выводы по работе

1. Эффективность метода: Алгоритм демонстрирует хорошие результаты для текстурированных объектов при плавном движении.

2. Ограничения метода: При быстрых перемещениях, вращениях или значительных изменениях освещения качество трекинга снижается.

3. Важность параметров: Правильный подбор параметров детектора точек и оптического потока критически важен для качества трекинга.

4. Стабильность трекинга: Алгоритм успешно отслеживает объект на протяжении 83% кадров видео, что является хорошим показателем для базового метода.

## 5. Использованные источники

1. OpenCV документация: Optical Flow - Lucas-Kanade Method
2. OpenCV документация: Shi-Tomasi Corner Detector
3. Lucas, B. D., & Kanade, T. (1981). An iterative image registration technique with an application to stereo vision.
4. Shi, J., & Tomasi, C. (1994). Good features to track.
